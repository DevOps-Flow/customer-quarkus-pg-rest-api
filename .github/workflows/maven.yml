name: Release Native • Build, Image, Push & ArgoCD Sync

on:
  push:
    branches:
      - master

concurrency:
  group: release-native-${{ github.ref }}
  cancel-in-progress: false

env:
  # Se não existir, cai no fallback.
  DOCKER_IMAGE: ${{ vars.DOCKER_IMAGE }}

jobs:
  release:
    name: Build once (native) • Docker • Push • ArgoCD
    runs-on: arc-runner-set

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21 + Maven cache
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: maven

      - name: Setup Maven 3.9.9
        uses: stCarolas/setup-maven@v5
        with:
          maven-version: 3.9.9

      - name: Extract project version from pom.xml
        id: ver
        run: |
          VERSION=$(mvn -q -DforceStdout help:evaluate -Dexpression=project.version)
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Project version: $VERSION"

      - name: Decide image name
        id: img
        run: |
          if [ -z "${{ env.DOCKER_IMAGE }}" ] || [ "${{ env.DOCKER_IMAGE }}" = "null" ]; then
            REPO_NAME=$(basename "$GITHUB_REPOSITORY")
            IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${REPO_NAME}"
          else
            IMAGE="${{ env.DOCKER_IMAGE }}"
          fi
          echo "IMAGE=$IMAGE" >> "$GITHUB_OUTPUT"
          echo "Imagem alvo: $IMAGE"

      # ===== BUILD NATIVO (UMA ÚNICA VEZ) =====
      - name: Build Quarkus Native (container-build)
        run: |
          mvn -B -ntp package -Pnative -Dquarkus.native.container-build=true

      - name: Upload native binary artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: native-runner
          path: target/*-runner
          retention-days: 14

      # ===== DOCKER: LOGIN, BUILD & PUSH =====
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker Hub login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push image (version + latest)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.native
          push: true
          tags: |
            ${{ steps.img.outputs.IMAGE }}:${{ steps.ver.outputs.VERSION }}
            ${{ steps.img.outputs.IMAGE }}:latest
          # Se precisar multi-arch, descomente:
          # platforms: linux/amd64,linux/arm64
          build-args: |
            APP_VERSION=${{ steps.ver.outputs.VERSION }}

      # ===== ARGO CD: SYNC COM TOKEN DA CONTA ci =====
      - name: Install Argo CD CLI (no-root safe)
        env:
          VER: v2.12.3
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.local/bin"
          curl -fsSL -o "$HOME/.local/bin/argocd" \
            "https://github.com/argoproj/argo-cd/releases/download/${VER}/argocd-linux-amd64"
          chmod +x "$HOME/.local/bin/argocd"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          argocd version --client
          
      - name: Argo CD refresh & sync
        env:
          ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
          ARGOCD_TOKEN:  ${{ secrets.ARGOCD_TOKEN }}
          # Use secrets.ARGOCD_APP OU vars.ARGOCD_APP (ajuste a linha de baixo):
          ARGOCD_APP:    ${{ secrets.ARGOCD_APP }}
        run: |
          set -e
          # Login por token (ajuste --insecure se tiver certificado válido)
          argocd login "$ARGOCD_SERVER" --grpc-web --auth-token "$ARGOCD_TOKEN" --insecure
          # Recheca origem e sincroniza
          argocd app get "$ARGOCD_APP" --refresh
          argocd app sync "$ARGOCD_APP" --prune --timeout 600
          argocd app wait "$ARGOCD_APP" --health --timeout 600
