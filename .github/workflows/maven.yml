name: Release Native • Build, Image, Push & ArgoCD Sync

on:
  push:
    branches:
      - master

concurrency:
  group: release-native-${{ github.ref }}
  cancel-in-progress: false

env:
  DOCKER_IMAGE: ${{ vars.DOCKER_IMAGE }}

jobs:
  release:
    name: Build once (native) • Docker • Push • Update manifest • ArgoCD
    runs-on: arc-runner-set

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21 + Maven cache
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: maven

      - name: Setup Maven 3.9.9
        uses: stCarolas/setup-maven@v5
        with:
          maven-version: 3.9.9

      - name: Extract project version from pom.xml
        id: ver
        run: |
          VERSION=$(mvn -q -DforceStdout help:evaluate -Dexpression=project.version)
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Project version: $VERSION"

      - name: Decide image name
        id: img
        run: |
          if [ -z "${{ env.DOCKER_IMAGE }}" ] || [ "${{ env.DOCKER_IMAGE }}" = "null" ]; then
            REPO_NAME=$(basename "$GITHUB_REPOSITORY")
            IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${REPO_NAME}"
          else
            IMAGE="${{ env.DOCKER_IMAGE }}"
          fi
          echo "IMAGE=$IMAGE" >> "$GITHUB_OUTPUT"
          echo "Imagem alvo: $IMAGE"

      # ===== BUILD NATIVO (UMA ÚNICA VEZ) =====
      - name: Build Quarkus Native (container-build)
        run: mvn -B -ntp package -Pnative -Dquarkus.native.container-build=true

      # ===== DOCKER: LOGIN, BUILD & PUSH =====
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker Hub login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push image (version + latest)
        id: dkr
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.native
          push: true
          tags: |
            ${{ steps.img.outputs.IMAGE }}:${{ steps.ver.outputs.VERSION }}
            ${{ steps.img.outputs.IMAGE }}:latest
          build-args: |
            APP_VERSION=${{ steps.ver.outputs.VERSION }}

      # ===== UPDATE MANIFEST (20-deployment-service.yaml) =====
      - name: Update deployment image reference (tag legível)
        env:
          IMAGE:  ${{ steps.img.outputs.IMAGE }}
          VERSION: ${{ steps.ver.outputs.VERSION }}
        run: |
          set -euo pipefail
          IMG="${IMAGE}:${VERSION}"

          echo "Atualizando imagem no 20-deployment-service.yaml -> ${IMG}"

          # instala yq no diretório do usuário (evita problemas de permissão)
          mkdir -p "$HOME/.local/bin"
          curl -fsSL -o "$HOME/.local/bin/yq" \
            https://github.com/mikefarah/yq/releases/download/v4.44.1/yq_linux_amd64
          chmod +x "$HOME/.local/bin/yq"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

          # Atualiza a imagem do container principal do Deployment "customer-api"
          "$HOME/.local/bin/yq" -i '
            (. | select(.kind=="Deployment" and .metadata.name=="customer-api")
               .spec.template.spec.containers[]
               | select(.name=="customer-api")).image = strenv(IMG)
          ' 20-deployment-service.yaml

          git config user.name  "ci-bot"
          git config user.email "ci-bot@users.noreply.github.com"
          git add 20-deployment-service.yaml
          git commit -m "deploy: update image -> ${IMAGE}:${VERSION}"
          git push

      # ===== ARGO CD: SYNC COM TOKEN DA CONTA ci =====
      - name: Argo CD via CLI em container (sem login)
        env:
          VER: v2.12.3
          ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
          ARGOCD_TOKEN:  ${{ secrets.ARGOCD_TOKEN }}
          ARGOCD_APP:    ${{ secrets.ARGOCD_APP }}
        run: |
          set -eo pipefail
          docker pull quay.io/argoproj/argocd:${VER}

          # Refresh, sync e wait via token (sem login)
          for CMD in \
            "app get \"$ARGOCD_APP\" --refresh" \
            "app sync \"$ARGOCD_APP\" --prune --timeout 600" \
            "app wait \"$ARGOCD_APP\" --health --timeout 600"
          do
            echo "Executando: argocd $CMD"
            docker run --rm \
              -e ARGOCD_SERVER="$ARGOCD_SERVER" \
              -e ARGOCD_TOKEN="$ARGOCD_TOKEN" \
              -e ARGOCD_APP="$ARGOCD_APP" \
              quay.io/argoproj/argocd:${VER} \
              sh -lc "argocd --grpc-web --insecure \
                --server \"\$ARGOCD_SERVER\" --auth-token \"\$ARGOCD_TOKEN\" \
                \$CMD"
          done
